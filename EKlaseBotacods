# bot.py
import asyncio
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage

import requests
from bs4 import BeautifulSoup
import random
from datetime import datetime

# ========================= CONFIG =========================
TOKEN = "8333674415:AAFjmtAHgj-n08mg88Ai2C0afGpXc0rGsLo"          # Get from @BotFather
# Leave empty if you want users to enter credentials via /login
EKLASE_LOGIN = ""
EKLASE_PASSWORD = ""

# ===========================================================
logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# FSM states
class AuthState(StatesGroup):
    waiting_login = State()
    waiting_password = State()

# In-memory user storage (use database in production)
users = {}  # user_id -> {login, password, points, level}

# ======================== E-KLASE PARSER ========================
class EKlase:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        })

    def login(self, login, password):
        url = "https://my.e-klase.lv/Account/Login"
        r = self.session.get(url)
        soup = BeautifulSoup(r.text, 'html.parser')
        token = soup.find("input", {"name": "__RequestVerificationToken"})["value"]

        data = {
            "UserName": login,
            "Password": password,
            "__RequestVerificationToken": token
        }
        resp = self.session.post(url, data=data)
        return "mana lapa" in resp.url.lower() or resp.status_code == 200

    def get_homework(self):
        try:
            r = self.session.get("https://my.e-klase.lv/Homework")
            soup = BeautifulSoup(r.text, "html.parser")
            tasks = []
            for row in soup.select(".homework-row"):
                date = row.select_one(".date").text.strip() if row.select_one(".date") else "No date"
                subject = row.select_one(".subject").text.strip()
                task = row.select_one(".description").text.strip()
                tasks.append(f"ğŸ“… {date}\nğŸ“š {subject}\nâœï¸ {task}\n")
            return tasks if tasks else ["No new homework today! ğŸ‰"]
        except Exception as e:
            logging.error(e)
            return ["Failed to load homework ğŸ˜”"]

ek = EKlase()

# ======================== MOTIVATION (in Latvian) ========================
motivations = [
    "Tu esi spÄ“jÄ«gs uz daudz vairÄk, nekÄ domÄ! ğŸ’ª",
    "Katra atrisinÄta uzdevuma padara tevi par supervaroni ğŸ¦¸â€â™‚ï¸",
    "Nevis \"grÅ«ti\", bet \"vÄ“l neesmu iemÄcÄ«jies\" ğŸ”¥",
    "Tava nÄkotne pateiks paldies par Å¡odienu! ğŸŒŸ",
    "Tu neesi slinks â€“ tu esi uzlÄdÄ“Å¡anÄs reÅ¾Ä«mÄ ğŸ˜",
    "Pat Einsteinam bija sliktas dienas. TurpinÄm! ğŸš€",
    "MÄcÄ«ties = ieguldÄ«t sevÄ«. Tu esi labÄkais ieguldÄ«jums! ğŸ’°"
]

# ======================== COMMAND HANDLERS ========================
@dp.message(Command("start"))
async def start(message: Message):
    user_id = message.from_user.id
    if user_id not in users:
        await message.answer(
            "Sveiks! I'm your personal e-klase study helper! ğŸ¤–\n\n"
            "To get started, I need your e-klase credentials (100% private).\n"
            "Type /login and follow the instructions!"
        )
    else:
        data = users[user_id]
        await message.answer(
            f"Welcome back, champion! ğŸ†\n"
            f"Level: {data['level']} | Points: {data['points']}\n\n"
            "What shall we do today?\n"
            "/homework â€“ show today's tasks\n"
            "/motivation â€“ get inspired\n"
            "/help â€“ smart hints (I won't do it for you!)"
        )

@dp.message(Command("login"))
async def login_cmd(message: Message, state: FSMContext):
    await message.answer("Enter your e-klase username or phone number:")
    await state.set_state(AuthState.waiting_login)

@dp.message(AuthState.waiting_login)
async def get_login(message: Message, state: FSMContext):
    await state.update_data(login=message.text)
    await message.answer("Now enter your password (it won't be shown to anyone):")
    await state.set_state(AuthState.waiting_password)

@dp.message(AuthState.waiting_password)
async def get_password(message: Message, state: FSMContext):
    data = await state.get_data()
    login = data['login']
    password = message.text
    user_id = message.from_user.id

    await message.answer("Logging in to e-klase... â³")

    if ek.login(login, password):
        users[user_id] = {
            "login": login,
            "password": password,
            "points": users.get(user_id, {}).get("points", 0),
            "level": users.get(user_id, {}).get("level", 1)
        }
        await message.answer(
            "âœ… Successfully logged in!\n\n"
            "You can now use /homework anytime!\n"
            "+50 points as a bravery bonus ğŸ˜‰"
        )
        users[user_id]["points"] += 50
        await state.clear()
    else:
        await message.answer("Wrong username or password ğŸ˜” Try again: /login")

@dp.message(Command("homework"))
async def homework(message: Message):
    user_id = message.from_user.id
    if user_id not in users:
        await message.answer("You need to log in first! /login")
        return

    await message.answer("Loading homework... ğŸ“–")
    tasks = ek.get_homework()
    response = "TODAY'S & UPCOMING HOMEWORK\n\n"
    for t in tasks[:10]:
        response += t + "â€”\n"
    response += "\nYou got this! ğŸ’ª"
    await message.answer(response)

@dp.message(Command("motivation"))
async def motivation(message: Message):
    mot = random.choice(motivations)
    await message.answer(f"ğŸ’š {mot}")

# Smart help â€“ never gives direct answers
@dp.message(F.text.regexp(r"(how|what|task|help|palÄ«dz)").lower())
async def smart_help(message: Message):
    hints = [
        "Tell me what YOU already know about this topic. Let's start there! ğŸ§ ",
        "What do you think the first step could be? I'll check it for you! âœ…",
        "Try writing your own answer â€“ I'll tell you if you're on the right track ğŸ˜‰",
        "Think: what did the teacher want you to learn with this task?",
        "I'll give you a hint, but only after you guess at least one step! ğŸ”¥"
    ]
    await message.answer(random.choice(hints))

# Reward system
@dp.message(F.text.lower().contains("thanks") | F.text.lower().contains("done") | 
            F.text.lower().contains("paldies") | F.text.lower().contains("izdevÄs"))
async def reward(message: Message):
    user_id = message.from_user.id
    if user_id in users:
        users[user_id]["points"] += 10
        if users[user_id]["points"] >= (users[user_id]["level"] * 100):
            users[user_id]["level"] += 1
            await message.answer(f"LEVEL UP! You're now level {users[user_id]['level']}! ğŸ†")
        else:
            await message.answer(f"+10 points! Total: {users[user_id]['points']} ğŸ’")

# ======================== START BOT ========================
async def main():
    print("Bot is starting...")
    await dp.start_polling(bot)

if name == "__main__":
    asyncio.run(main())
